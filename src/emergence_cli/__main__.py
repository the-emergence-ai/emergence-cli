import os, pathlib, shutil, textwrap, json, sys
import click
import subprocess  # ðŸ‘ˆ for docker build
from . import __version__

@click.group()
@click.version_option(__version__)
def cli():
    """Emergence commandâ€‘line tool."""
    pass

@cli.command()
@click.argument("name")
def init(name: str):
    """
    Scaffold a **helloâ€‘agent** in a new folder called NAME.
    """
    target = pathlib.Path(name).resolve()
    if target.exists():
        click.secho("Folder already exists â€” aborting.", fg="red")
        raise SystemExit(1)

    # === minimal file templates ============================================
    agent_py = textwrap.dedent(
        f"""\
        \"\"\"Echo agent generated by Emergence CLI.\"\"\"
        import json, sys

        def handle(msg: dict) -> dict:
            \"\"\"Very first prototype â€” just echoes HELP prompts.\"\"\"
            if msg.get("verb") == "HELP":
                return {{
                    "id": msg["id"],
                    "from": "{name}",
                    "to": msg["from"],
                    "verb": "DONE",
                    "data": {{"echo": msg["data"]}}
                }}
            raise ValueError("Unsupported verb")

        if __name__ == "__main__":
            incoming = json.load(sys.stdin)
            json.dump(handle(incoming), sys.stdout)
        """
    )

    dockerfile = textwrap.dedent(
        """\
        FROM python:3.11-slim
        WORKDIR /app
        COPY agent.py .
        CMD ["python", "agent.py"]
        """
    )

    readme = f"# {name}\n\nMinimal echo agent generated by **Emergence CLI**."

    # === write files ========================================================
    target.mkdir()
    (target / "agent.py").write_text(agent_py)
    (target / "Dockerfile").write_text(dockerfile)
    (target / "README.md").write_text(readme)

    click.secho(f"âœ…  Scaffolding created in ./{name}", fg="green")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# `emergence build <path> [--tag my/image:tag]`
# builds a Docker image for the agent folder
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@cli.command()
@click.argument("path", type=click.Path(exists=True, file_okay=False))
@click.option("--tag", "-t", help="Optional image tag (default: emergence/<folder>:latest)")
def build(path: str, tag: str | None):
    """
    Build a Docker image from an agent folder.
    """
    folder = pathlib.Path(path).resolve()
    img_tag = tag or f"emergence/{folder.name}:latest"

    click.echo(f"ðŸ”¨  Building {img_tag} ...")
    try:
        subprocess.run(
            ["docker", "build", "-t", img_tag, str(folder)],
            check=True,
        )
        click.secho(f"âœ…  Image built: {img_tag}", fg="green")
    except subprocess.CalledProcessError:
        click.secho("â›”  Docker build failed.", fg="red")
        raise SystemExit(1)
